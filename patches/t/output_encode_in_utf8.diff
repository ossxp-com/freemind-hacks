From: Jiang Xin <jiangxin@moon.ossxp.com>
Subject: [PATCH] t/output_encode_in_utf8

Save mm file in UTF-8 format.

Signed-off-by: Jiang Xin <jiangxin@moon.ossxp.com>

---
 accessories/freemind2flash.xsl                    |    4 +-
 accessories/plugins/ExportWithXSLT.java           |    3 +-
 freemind/main/FreeMind.java                       |    3 ++
 freemind/main/HtmlTools.java                      |    2 +-
 freemind/main/XMLElement.java                     |    7 +++-
 freemind/modes/StylePattern.java                  |    2 +-
 freemind/modes/mindmapmode/MindMapController.java |    3 +-
 freemind/modes/mindmapmode/MindMapHTMLWriter.java |    4 +-
 freemind/modes/mindmapmode/MindMapMapModel.java   |   32 ++++++++++++++++++--
 9 files changed, 46 insertions(+), 14 deletions(-)

diff --git a/accessories/freemind2flash.xsl b/accessories/freemind2flash.xsl
index 4d588a6..489bcad 100644
--- a/accessories/freemind2flash.xsl
+++ b/accessories/freemind2flash.xsl
@@ -1,4 +1,4 @@
-<?xml version="1.0" encoding="iso-8859-1"?>
+<?xml version="1.0" encoding="utf-8"?>
 <xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                 version="1.0">
 
@@ -44,7 +44,7 @@
   <xsl:template match="/">
     <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
       <head>
-<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
+<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
 		<title><xsl:call-template name="output-title" /></title>
         <xsl:element name="script">
             <xsl:attribute name="type">text/javascript</xsl:attribute>
diff --git a/accessories/plugins/ExportWithXSLT.java b/accessories/plugins/ExportWithXSLT.java
index 850e3f8..d29c638 100644
--- a/accessories/plugins/ExportWithXSLT.java
+++ b/accessories/plugins/ExportWithXSLT.java
@@ -52,6 +52,7 @@ import javax.xml.transform.stream.StreamSource;
 import accessories.plugins.util.html.ClickableImageCreator;
 import accessories.plugins.util.xslt.ExportDialog;
 import freemind.extensions.ExportHook;
+import freemind.main.FreeMind;
 import freemind.main.Resources;
 import freemind.main.Tools;
 import freemind.modes.MindIcon;
@@ -175,7 +176,7 @@ public class ExportWithXSLT extends ExportHook {
     {
         boolean success = true;
 //      Generating output Stream            
-        BufferedWriter fileout = new BufferedWriter( new OutputStreamWriter( new FileOutputStream(pDirectoryName+File.separator + "map.mm") ) );
+        BufferedWriter fileout = new BufferedWriter( new OutputStreamWriter( new FileOutputStream(pDirectoryName+File.separator + "map.mm"), FreeMind.DEFAULT_CHARSET ) );
         getController().getMap().getFilteredXml(fileout);
         return success;
     }
diff --git a/freemind/main/FreeMind.java b/freemind/main/FreeMind.java
index 4309d02..948b3f5 100644
--- a/freemind/main/FreeMind.java
+++ b/freemind/main/FreeMind.java
@@ -81,6 +81,9 @@ import freemind.view.mindmapview.MapView;
 
 public class FreeMind extends JFrame implements FreeMindMain {
 
+	// OSSXP.COM: set output character set to utf-8.
+	public static final String DEFAULT_CHARSET = "UTF-8";
+
 	private static final String SPLIT_PANE_POSITION = "split_pane_position";
 
 	private static final String SPLIT_PANE_LAST_POSITION = "split_pane_last_position";
diff --git a/freemind/main/HtmlTools.java b/freemind/main/HtmlTools.java
index c309a70..64b307f 100644
--- a/freemind/main/HtmlTools.java
+++ b/freemind/main/HtmlTools.java
@@ -332,7 +332,7 @@ public class HtmlTools {
 		for (int i = 0; i < text.length(); ++i) {
 			myChar = text.charAt(i);
 			intValue = (int) text.charAt(i);
-			if (intValue < 32 || intValue > 126) {
+			if (intValue < 32 || !Resources.getInstance().getBoolProperty("wh_nonascii_in_utf8") && intValue > 126) {
 				result.append("&#x").append(Integer.toString(intValue, 16))
 						.append(';');
 			} else {
diff --git a/freemind/main/XMLElement.java b/freemind/main/XMLElement.java
index 2174b5c..e610275 100644
--- a/freemind/main/XMLElement.java
+++ b/freemind/main/XMLElement.java
@@ -2118,7 +2118,8 @@ public class XMLElement
     {
         try {
             ByteArrayOutputStream out = new ByteArrayOutputStream();
-            OutputStreamWriter writer = new OutputStreamWriter(out);
+            // OSSXP.COM: Encode output to default_charset(UTF-8). 
+            OutputStreamWriter writer = new OutputStreamWriter(out, FreeMind.DEFAULT_CHARSET);
             this.write(writer);
             writer.flush();
             return new String(out.toByteArray());
@@ -2270,7 +2271,9 @@ public class XMLElement
                     break;
                 default:
                     int unicode = (int) ch;
-                    if((unicode < 32)||(unicode > 126)) {
+                    // OSSXP.COM: do not convert Chinese characters into &#blahblah;
+                    if (!Resources.getInstance().getBoolProperty("wh_nonascii_in_utf8") && (unicode > 126) || (unicode < 32)) {
+
                         writer.write('&'); writer.write('#');
                         writer.write('x');
                         writer.write(Integer.toString(unicode, 16));
diff --git a/freemind/modes/StylePattern.java b/freemind/modes/StylePattern.java
index c3644eb..7db2e30 100644
--- a/freemind/modes/StylePattern.java
+++ b/freemind/modes/StylePattern.java
@@ -504,7 +504,7 @@ public class StylePattern {
 
 
             //Generating output Stream
-            BufferedWriter fileout = new BufferedWriter( new OutputStreamWriter( new FileOutputStream(file) ) );
+            BufferedWriter fileout = new BufferedWriter( new OutputStreamWriter( new FileOutputStream(file) ) ); // in comments
             pattern.write(fileout);
 
             fileout.close();
diff --git a/freemind/modes/mindmapmode/MindMapController.java b/freemind/modes/mindmapmode/MindMapController.java
index 014d7af..6bfe58c 100644
--- a/freemind/modes/mindmapmode/MindMapController.java
+++ b/freemind/modes/mindmapmode/MindMapController.java
@@ -114,6 +114,7 @@ import freemind.extensions.UndoEventReceiver;
 import freemind.extensions.HookFactory.RegistrationContainer;
 import freemind.main.ExampleFileFilter;
 import freemind.main.FixedHTMLWriter;
+import freemind.main.FreeMind;
 import freemind.main.HtmlTools;
 import freemind.main.Resources;
 import freemind.main.Tools;
@@ -1742,7 +1743,7 @@ freemind.main.Resources.getInstance().logException(					e1);
 
     static public void saveHTML(MindMapNodeModel rootNodeOfBranch, File file) throws IOException {
         BufferedWriter fileout = new BufferedWriter(new OutputStreamWriter(
-                new FileOutputStream(file)));
+                new FileOutputStream(file), FreeMind.DEFAULT_CHARSET));
         MindMapHTMLWriter htmlWriter = new MindMapHTMLWriter(
                 fileout);
         htmlWriter.saveHTML(rootNodeOfBranch);      
diff --git a/freemind/modes/mindmapmode/MindMapHTMLWriter.java b/freemind/modes/mindmapmode/MindMapHTMLWriter.java
index 52276ea..f2d0616 100644
--- a/freemind/modes/mindmapmode/MindMapHTMLWriter.java
+++ b/freemind/modes/mindmapmode/MindMapHTMLWriter.java
@@ -92,7 +92,7 @@ class MindMapHTMLWriter {
         for (int i = 0; i < len; ++i) {
             myChar = text.charAt(i);
             intValue = (int) text.charAt(i);
-            if (intValue >= 128) {
+            if (!Resources.getInstance().getBoolProperty("wh_nonascii_in_utf8") && intValue >= 128) {
                 result.append(convertSpecialChar(myChar));
             }
             else {
@@ -690,4 +690,4 @@ class MindMapHTMLWriter {
         return Resources.getInstance().getProperty(key);
     }
 
-}
\ No newline at end of file
+}
diff --git a/freemind/modes/mindmapmode/MindMapMapModel.java b/freemind/modes/mindmapmode/MindMapMapModel.java
index 5143e71..acf305f 100644
--- a/freemind/modes/mindmapmode/MindMapMapModel.java
+++ b/freemind/modes/mindmapmode/MindMapMapModel.java
@@ -172,7 +172,7 @@ public class MindMapMapModel extends MapAdapter  {
    public boolean saveTXT(MindMapNodeModel rootNodeOfBranch, File file) {
         // Returns success of the operation.
         try {
-            BufferedWriter fileout = new BufferedWriter( new OutputStreamWriter( new FileOutputStream(file) ) );
+            BufferedWriter fileout = new BufferedWriter( new OutputStreamWriter( new FileOutputStream(file), FreeMind.DEFAULT_CHARSET ) );
             rootNodeOfBranch.saveTXT(fileout,/*depth=*/0);
             fileout.close();
             return true;
@@ -253,7 +253,8 @@ public class MindMapMapModel extends MapAdapter  {
         	if(timerForAutomaticSaving != null) {
         		timerForAutomaticSaving.cancel();
         	}
-            BufferedWriter fileout = new BufferedWriter( new OutputStreamWriter( new FileOutputStream(file) ) );
+            // OSSXP.COM: save file using default character set.
+            BufferedWriter fileout = new BufferedWriter( new OutputStreamWriter( new FileOutputStream(file), FreeMind.DEFAULT_CHARSET ) );
             getXml(fileout);
 
             if(!isInternal) {
@@ -281,6 +282,8 @@ public class MindMapMapModel extends MapAdapter  {
 	 * @throws IOException
 	 */
 	private void getXml(Writer fileout, boolean saveInvisible) throws IOException {
+		// OSSXP.COM: write xml declare.
+		fileout.write("<?xml version=\"1.0\" encoding=\"" + FreeMind.DEFAULT_CHARSET + "\"?>\n");
 		fileout.write("<map ");
 		fileout.write("version=\""+FreeMind.XML_VERSION+"\"");
 		fileout.write(">\n");
@@ -362,9 +365,30 @@ public class MindMapMapModel extends MapAdapter  {
 
     MindMapNodeModel loadTree(File file) throws XMLParseException, IOException {
         int versionInfoLength;
-		versionInfoLength = EXPECTED_START_STRINGS[0].length();
+        versionInfoLength = 0;
         // reading the start of the file:
-        StringBuffer buffer = readFileStart(file, versionInfoLength);
+        // OSSXP.COM: 
+        //     because we add a xml declare, the mm file now begin with "<xml", 
+        //     so direct match mmap version will failed.
+        //     search "<map" and store matched line into buffer.
+        BufferedReader in=null;
+        String buffer = null;
+        try {
+        	// get the file start into the memory:
+        	in = new BufferedReader(new FileReader(file));
+        	while ((buffer = in.readLine()) != null) {
+        		// buffer contains line start with "<map", stop matching.
+        		if (buffer.substring(0,4).equals("<map"))
+        		{
+        			break;
+        		}
+        	}
+        	in.close();
+        } catch (Exception e) {
+        	e.printStackTrace();
+        	buffer = "";
+        }
+        
         // the resulting file is accessed by the reader:
         Reader reader = null;
         for(int i = 0; i < EXPECTED_START_STRINGS.length; i++){
-- 
tg: (918d0c3..) t/output_encode_in_utf8 (depends on: master)
