From: Jiang Xin <jiangxin@moon.ossxp.com>
Subject: [PATCH] t/load_mm_with_mmx_file

When load mindmap, join <filename>.mm file with .<filename>.mmx.

Signed-off-by: Jiang Xin <jiangxin@moon.ossxp.com>

---
 MANIFEST.MF                                        |    1 +
 build.xml                                          |    4 +-
 freemind.bat                                       |    2 +-
 freemind.sh                                        |    1 +
 freemind/main/Tools.java                           |  121 +++++++++++++++++++-
 freemind/modes/mindmapmode/MindMapMapModel.java    |    4 +-
 .../modes/mindmapmode/freemind_join_mm_mmx.xslt    |   36 ++++++
 7 files changed, 161 insertions(+), 8 deletions(-)

diff --git a/MANIFEST.MF b/MANIFEST.MF
index e6db851..1f7a44f 100644
--- a/MANIFEST.MF
+++ b/MANIFEST.MF
@@ -9,5 +9,6 @@ Class-Path: freemind.jar
   bindings.jar
                           SimplyHTML/gnu-regexp-1.1.4.jar
   SimplyHTML/SimplyHTML.jar
+  saxon.jar
 Created-By: Joerg Mueller
 
diff --git a/build.xml b/build.xml
index 27f19a5..3031a11 100644
--- a/build.xml
+++ b/build.xml
@@ -49,7 +49,7 @@
 		<classpath path="${jibxlibs}"/>
 	</taskdef>
 
-	<property name="classpath" value="${jibxruntimelibs}:${jibxjar}:lib/commons-lang-2.0.jar:lib/forms-1.0.5.jar:lib/SimplyHTML/SimplyHTML.jar"/>
+	<property name="classpath" value="${jibxruntimelibs}:${jibxjar}:lib/commons-lang-2.0.jar:lib/forms-1.0.5.jar:lib/SimplyHTML/SimplyHTML.jar:lib/saxon.jar"/>
 
 	  <target name="xmlbind.checkStatusOfGeneration">
 	    <uptodate property="xmlbind.isUpToDate"
@@ -197,6 +197,7 @@
 				<include name="commons-lang-2.0.jar"/>
 				<include name="forms-1.0.5.jar"/>
 				<include name="bindings.jar"/>
+				<include name="saxon.jar"/>
 				<include name="jibx/jibx-run.jar"/>
 				<include name="jibx/xpp3.jar"/>
 				<include name="SimplyHTML/gnu-regexp-1.1.4.jar"/>
@@ -378,6 +379,7 @@
 				<include name="Resources*"/>
 				<include name="mindmap_menus.xml"/>
 				<include name="**/freemind_version_updater.xslt"/>
+				<include name="**/freemind_join_mm_mmx.xslt"/>
 			</fileset>
 		</jar>
 		<ant antfile="${acc_build}" target="jar"/>
diff --git a/freemind.bat b/freemind.bat
index d10bb7d..7171493 100644
--- a/freemind.bat
+++ b/freemind.bat
@@ -1,2 +1,2 @@
 @echo off
-java -cp lib\freemind.jar;lib\commons-lang-2.0.jar;lib\forms-1.0.5.jar;lib\jibx\jibx-run.jar;lib\jibx\xpp3.jar;lib\bindings.jar freemind.main.FreeMindStarter
+java -cp lib\freemind.jar;lib\commons-lang-2.0.jar;lib\forms-1.0.5.jar;lib\jibx\jibx-run.jar;lib\jibx\xpp3.jar;lib\bindings.jar;lib\saxon.jar freemind.main.FreeMindStarter
diff --git a/freemind.sh b/freemind.sh
index 5cd29ee..16c4c52 100644
--- a/freemind.sh
+++ b/freemind.sh
@@ -201,6 +201,7 @@ ${freedir}/lib/jibx/xpp3.jar:\
 ${freedir}/lib/bindings.jar:\
 ${freedir}/lib/commons-lang-2.0.jar:\
 ${freedir}/lib/forms-1.0.5.jar:\
+${freedir}/lib/saxon.jar:\
 ${freedir}"
 if [ "${JAVA_TYPE}" = "sun" ]
 then
diff --git a/freemind/main/Tools.java b/freemind/main/Tools.java
index bf805de..cf860e5 100644
--- a/freemind/main/Tools.java
+++ b/freemind/main/Tools.java
@@ -95,6 +95,12 @@ import javax.xml.transform.stream.StreamSource;
 import freemind.modes.MindMapNode;
 import freemind.view.mindmapview.NodeView;
 
+//OSSXP.COM: classes for .mm and .mmx join.
+import javax.xml.parsers.DocumentBuilder;
+import javax.xml.parsers.DocumentBuilderFactory;
+import javax.xml.transform.dom.DOMSource;
+import org.w3c.dom.Document;
+
 /**
  * @author foltin
  *
@@ -1001,7 +1007,8 @@ public class Tools {
 		    return new StringReader(writer.getBuffer().toString());
 	    }
 	    else{
-	        return getActualReader(file);
+	        // OSSXP.COM
+	        return getActualReader(file, frame);
 	    }
 	}
 
@@ -1019,10 +1026,116 @@ public class Tools {
 		return HtmlTools.replaceIllegalXmlCharacters(fileContents);
 	}
 
-	/** Creates a default reader that just reads the given file.
-	 * @throws FileNotFoundException
+	/*
+	 * OSSXP.COM: hacked FreeMind saved two seperate files, .mm and .mmx file.
+	 * Join them in runtime using XSLT TransformerFactory.
+	 * TODO: Improvement needed. the joining stage may very slow, so disable it.
+	 */
+	public static Reader getActualReader(File file, FreeMindMain frame) throws IOException {
+	    if (!Resources.getInstance().getBoolProperty("wh_save_extra_attrs_in_aux_file"))
+	    {
+	    	return getActualReaderXml(file);
+	    }
+	    // load .mmx file...
+	    String ext = Tools.getExtension(file.getName());
+	    String mmxFileName = "";
+
+	    // OSSXP.COM: can disable join .mm with .mmx here.
+	    // if(true) return getActualReaderXml(file);
+	    
+	    if(!ext.equals("mm")) 
+	    {
+	    	mmxFileName = "." + file.getName()+".mmx";
+	    }
+	    else 
+	    {
+	    	mmxFileName = "." + Tools.removeExtension(file.getName()) + ".mmx";
+	    }
+	    File mmxfile = new File(file.getParent(), mmxFileName);
+	    
+	    if (!mmxfile.exists())
+	    {
+	    	return getActualReaderXml(file);
+	    }
+
+	    URL updaterUrl = null;
+	    InputStream inputStream = null;
+	    Source xsltSource = null;
+	    StringWriter buffwriter = null;
+	    Result result = null;
+	    TransformerFactory tf = null;
+	    Transformer transformer = null;
+	    String mmxFileFullName = mmxfile.toURI().toString();
+	    try {
+	        // try to convert map with xslt:
+	    	updaterUrl = frame.getResource(
+	                "freemind/modes/mindmapmode/freemind_join_mm_mmx.xslt");
+	        if (updaterUrl == null) {
+	            throw new IllegalArgumentException(
+	                    "freemind_join_mm_mmx.xslt not found.");
+	        }
+	        inputStream = updaterUrl.openStream();
+	        xsltSource = new StreamSource(inputStream);
+	        // get output:
+	        buffwriter = new StringWriter();
+	        result = new StreamResult(buffwriter);
+	        /* OSSXP.COM: create an instance of TransformerFactory.
+	         * the default xslt engine (com.sun.org.apache.xalan.internal.xsltc.trax...) 
+	         * may not support 'key()' in freemind_join_mm_mmx.xslt. 
+	         * Use saxon implement. */
+	        System.setProperty("javax.xml.transform.TransformerFactory", 
+	        		"com.icl.saxon.TransformerFactoryImpl");
+	        tf = TransformerFactory.newInstance();
+	        transformer = tf.newTransformer(xsltSource);
+	        transformer.setParameter("mmx_file", mmxFileFullName);
+	        transformer.transform(new StreamSource(file), result);
+
+	    } catch (Exception ex) {
+	        ex.printStackTrace();
+	        // exception: we take the file itself:
+	        return getActualReaderXml(file);
+	    } finally {
+	        if (inputStream != null) {
+	            inputStream.close();
+	        }
+	        if (buffwriter != null) {
+	            buffwriter.close();
+	        }
+	        inputStream = null;
+	        xsltSource = null;
+	        updaterUrl = null;
+	        result = null;
+	        transformer = null;
+	        tf = null;
+	    }
+	    return new StringReader(buffwriter.getBuffer().toString());
+	}
+
+	/* 
+	 * OSSXP.COM: In this hacked version, .mm file is a true XML file.
+	 * load XML file using DOM.
 	 */
-	public static Reader getActualReader(File file) throws FileNotFoundException {
+	private static Reader getActualReaderXml(File file) throws IOException {
+	    try
+	    {
+	        TransformerFactory tf = TransformerFactory.newInstance();
+	        Transformer transformer = tf.newTransformer();
+	        DocumentBuilderFactory domFactory = DocumentBuilderFactory.newInstance();
+	        DocumentBuilder domBuilder = domFactory.newDocumentBuilder();
+
+	        Document doc = domBuilder.parse(file);
+	        Source src = new DOMSource(doc);
+	        StringWriter buffwriter = new StringWriter();
+	        StreamResult result = new StreamResult(buffwriter);
+	        transformer.transform(src, result);
+
+	        return new StringReader(buffwriter.toString());
+	    }
+	    catch(Exception exp)
+	    {
+	    	exp.printStackTrace();
+	    }
+
 	    return new BufferedReader(new FileReader(file));
 	}
 
diff --git a/freemind/modes/mindmapmode/MindMapMapModel.java b/freemind/modes/mindmapmode/MindMapMapModel.java
index 5143e71..a4f44e9 100644
--- a/freemind/modes/mindmapmode/MindMapMapModel.java
+++ b/freemind/modes/mindmapmode/MindMapMapModel.java
@@ -375,7 +375,7 @@ public class MindMapMapModel extends MapAdapter  {
         	}
             if (mapStart.startsWith(EXPECTED_START_STRINGS[i])) {
                 // actual version:
-                reader = Tools.getActualReader(file);
+                reader = Tools.getActualReader(file, getFrame());
                 break;
             }
         }
@@ -389,7 +389,7 @@ public class MindMapMapModel extends MapAdapter  {
 					OptionalDontShowMeAgainDialog.ONLY_OK_SELECTION_IS_STORED)
 					.show().getResult();
 			if(showResult != JOptionPane.OK_OPTION) {
-				reader = Tools.getActualReader(file);
+				reader = Tools.getActualReader(file, getFrame());
 			} else {
 				reader = Tools.getUpdateReader(file, FREEMIND_VERSION_UPDATER_XSLT, getFrame());
 			}
diff --git a/freemind/modes/mindmapmode/freemind_join_mm_mmx.xslt b/freemind/modes/mindmapmode/freemind_join_mm_mmx.xslt
new file mode 100644
index 0000000..bee253b
--- /dev/null
+++ b/freemind/modes/mindmapmode/freemind_join_mm_mmx.xslt
@@ -0,0 +1,36 @@
+<xsl:stylesheet version="1.0"
+   xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+<!-- Usage:
+   xsltproc -stringparam mmx_file mindmap.mmx <this_xslt> mindmap.mm
+-->
+   <xsl:output method="xml" version="1.0" encoding="utf-8"
+       indent="no" />
+
+   <xsl:param name="mmx_file" />
+   <xsl:variable name="indexfile" select="document($mmx_file)" />
+
+   <xsl:key name="node-by-id" match="node" use="@ID"/>
+
+   <xsl:template match="map">
+       <map>
+           <xsl:copy-of select="@*" />
+           <xsl:apply-templates />
+       </map>
+   </xsl:template>
+
+   <xsl:template match="node">
+       <xsl:variable name="id" select="@ID" />
+       <xsl:copy>
+           <xsl:copy-of select="@*" />
+           <xsl:for-each select="$indexfile">
+               <xsl:copy-of select="key('node-by-id', $id)/@*" />
+           </xsl:for-each>
+           <xsl:apply-templates />
+       </xsl:copy>
+   </xsl:template>
+
+   <xsl:template match="*">
+     <xsl:copy-of select="."/>
+   </xsl:template>
+
+</xsl:stylesheet>
-- 
tg: (918d0c3..) t/load_mm_with_mmx_file (depends on: master)
